<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="generator" content="pandoc">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">         <meta name="author" content="Armin Bernstetter">          <meta name="dcterms.date" content="2019-07-20">          <title>The Spineless Tagless G-Machine</title>
        <style type="text/css">
        :root {
                /* This is the global variable for the default alignment. Defaults to left.    */
                /* Can be overriden in local YAML and for whole slides or individual elements  */
                --align-global: left;
                /* Column spacing, in same awkward unit as reveal's margin which is fraction of 
                space. Beware, does strange things if set too large. */
                --margin-columns: calc(0em * 100%);
                /* Now all the different font sizes */
                --font-size-base: 28px;
                --font-size-medium: calc(var(--font-size-base) * 1);
                --font-size-xx-small: calc(var(--font-size-base) * 0.4);
                --font-size-x-small: calc(var(--font-size-base) * 0.6);
                --font-size-small: calc(var(--font-size-base) * 0.8);
                --font-size-large: calc(var(--font-size-base) * 1.2);
                --font-size-x-large: calc(var(--font-size-base) * 1.4);
                --font-size-xx-large: calc(var(--font-size-base) * 1.6);
                /* This one defines the basic vertical spacing between elements */
                --spacing-vertical-base: 0.5em;
                --margin-bottom-elements-base: 0.5em;
                --margin-bottom-h1: calc(var(--margin-bottom-elements-base) * 1);
                --margin-bottom-h2: calc(var(--margin-bottom-elements-base) * 0);
                --margin-bottom-h2-block: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-h3: calc(var(--margin-bottom-elements-base) * 0);
                --margin-bottom-h3-block: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-p: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-ol: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-ul: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-dl: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-figure: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-img: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-blockquote: calc(var(--margin-bottom-elements-base) * 0.8);
                --margin-bottom-table: calc(var(--margin-bottom-elements-base) * 1);
                --margin-bottom-columns: calc(var(--margin-bottom-elements-base) * 0);       
                --margin-bottom-references: calc(var(--margin-bottom-elements-base) * 0.3);
                /* The next custom properties for the look of the decoration */
                --border-decoration-width: 20px;
                --border-decoration-padding: 10px;
                --border-decoration-style: solid;  
                /* whiteboard buttons */
                --whiteboard-icon-size: 2vmin;
                --whiteboard-active-color: rgb(42,157,223);
                --whiteboard-inactive-color: lightgrey;
                --whiteboard-background-color: rgb(250,250,250);      
        } 
        </style>
                        <style type="text/css">
            pre > code.sourceCode { white-space: pre; position: relative; }
            pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
            pre > code.sourceCode > span:empty { height: 1.2em; }
            .sourceCode { overflow: visible; }
            code.sourceCode > span { color: inherit; text-decoration: inherit; }
            div.sourceCode { margin: 1em 0; }
            pre.sourceCode { margin: 0; }
            @media screen {
            div.sourceCode { overflow: auto; }
            }
            @media print {
            pre > code.sourceCode { white-space: pre-wrap; }
            pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
            }
            pre.numberSource code
              { counter-reset: source-line 0; }
            pre.numberSource code > span
              { position: relative; left: -4em; counter-increment: source-line; }
            pre.numberSource code > span > a:first-child::before
              { content: counter(source-line);
                position: relative; left: -1em; text-align: right; vertical-align: baseline;
                border: none; display: inline-block;
                -webkit-touch-callout: none; -webkit-user-select: none;
                -khtml-user-select: none; -moz-user-select: none;
                -ms-user-select: none; user-select: none;
                padding: 0 4px; width: 4em;
                color: #aaaaaa;
              }
            pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
            div.sourceCode
              {   }
            @media screen {
            pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
            }
            code span.al { color: #ff0000; font-weight: bold; } /* Alert */
            code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
            code span.at { color: #7d9029; } /* Attribute */
            code span.bn { color: #40a070; } /* BaseN */
            code span.bu { } /* BuiltIn */
            code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
            code span.ch { color: #4070a0; } /* Char */
            code span.cn { color: #880000; } /* Constant */
            code span.co { color: #60a0b0; font-style: italic; } /* Comment */
            code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
            code span.do { color: #ba2121; font-style: italic; } /* Documentation */
            code span.dt { color: #902000; } /* DataType */
            code span.dv { color: #40a070; } /* DecVal */
            code span.er { color: #ff0000; font-weight: bold; } /* Error */
            code span.ex { } /* Extension */
            code span.fl { color: #40a070; } /* Float */
            code span.fu { color: #06287e; } /* Function */
            code span.im { } /* Import */
            code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
            code span.kw { color: #007020; font-weight: bold; } /* Keyword */
            code span.op { color: #666666; } /* Operator */
            code span.ot { color: #007020; } /* Other */
            code span.pp { color: #bc7a00; } /* Preprocessor */
            code span.sc { color: #4070a0; } /* SpecialChar */
            code span.ss { color: #bb6688; } /* SpecialString */
            code span.st { color: #4070a0; } /* String */
            code span.va { color: #19177c; } /* Variable */
            code span.vs { color: #4070a0; } /* VerbatimString */
            code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
        </style>
        
    <link rel="stylesheet" href="support/css/handout.css">
    

    <link rel="stylesheet" href="support/examiner/examiner.css">


    <!-- MathJax config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/ams']
            },
            svg: {
                minScale: .5,                  // smallest scaling factor to use
                matchFontHeight: false,        // true to match ex-height of surrounding font
                mtextInheritFont: false,       // true to make mtext elements use surrounding font
                merrorInheritFont: true,       // true to make merror text use surrounding font
                mathmlSpacing: false,          // true for MathML spacing rules, false for TeX rules
                skipAttributes: {},            // RFDa and other attributes NOT to copy to the output
                exFactor: .5,                  // default size of ex in em units
                displayAlign: 'center',        // default for indentalign when set to 'auto'
                displayIndent: '0',            // default for indentshift when set to 'auto'
                fontCache: 'none',             // or 'global' or 'none'
                localID: null,                 // ID to use for local font cache (for single equation processing)
                internalSpeechTitles: true,    // insert <title> tags with speech content
                titleID: 0                     // initial id number to use for aria-labeledby titles
            },
            tex: {
                tags: 'ams',
                packages: {
                    '[+]': ['ams']
                },
                macros: {
                    R: "{\\mathrm{{I}\\kern-.15em{R}}}",
                    laplace: "{\\Delta}",
                    grad: "{\\nabla}",
                    T: "^{\\mathsf{T}}",
                    norm: ['\\left\\Vert #1 \\right\\Vert', 1],
                    iprod: ['\\left\\langle #1 \\right\\rangle', 1],
                    vec: ['\\boldsymbol{\\mathbf{#1}}', 1],
                    mat: ['\\boldsymbol{\\mathbf{#1}}', 1],
                    set: ['\\mathcal{#1}', 1],
                    func: ['\\mathrm{#1}', 1],
                    trans: ['{#1}\\mkern-1mu^{\\mathsf{T}}', 1],
                    matrix: ['\\begin{bmatrix} #1 \\end{bmatrix}', 1],
                    vector: ['\\begin{pmatrix} #1 \\end{pmatrix}', 1],
                    of: ['\\mkern{-2mu}\\left( #1 \\right\)', 1],
                    diff: ['\\frac{\\mathrm{d}{#1}}{\\mathrm{d}{#2}}', 2],
                    pdiff: ['\\frac{\\partial {#1}}{\\partial {#2}}', 2],

                    vc: ['\\mathbf{#1}', 1],
                    abs: ['\\lvert#1\\rvert', 1],
                    norm: ['\\lVert#1\\rVert', 1],
                    det: ['\\lvert#1\\rvert', 1],
                    qt: ['\\hat{\\vc {#1}}', 1],
                    mt: ['\\boldsymbol{#1}', 1],
                    pt: ['\\boldsymbol{#1}', 1],
                    textcolor: ['\\color{#1}', 1]
                }
            },
            options: {
                // disable menu
                renderActions: {
                    addMenu: [0, '', '']
                },
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="support/vendor/mathjax/tex-svg.js">
    </script>

    <script>
      var socket = new WebSocket("ws://" + location.host + "/reload");
      socket.onmessage = function (event) {
        if (event.data.startsWith("reload!")) 
          window.location.reload(true);
      };
    </script>

                    </head>

    <body class="document handout" onload="initHandout();">
                        <header>
          <h1 class="title">The Spineless Tagless G-Machine</h1>
                    <h2 class="subtitle">How GHC Handles Partial Application</p>
                              <p class="lead author">Armin Bernstetter</p>
                              <p id="date" class="lead">2019-07-20</p>
                  </header>
                
<!-- body must not be indented or code blocks render badly -->
<!-- The following line must be left aligned! -->
<section class="slide level1">

<div class="slide-wrapper">
<hr />
<section id="haskell" class="slide level1">
<h1>Haskell</h1>
<div class="box columns column" style="width:30%;">
<h2 class="column" width="30%" id="section"></h2>
<img class="decker" data-src="img/haskell.png" alt="haskell.png">
</div>
<div class="box columns column" style="width:50%;">
<h2 class="column" width="50%" id="section-1"></h2>
<ul>
<li>Search for a “common functional language”</li>
<li>1987-1989 commitee meetings</li>
<li>1989 start of development, 1990 Haskell version 1.0</li>
<li>Named after mathematician Haskell Curry</li>
</ul>
<p><em>A history of Haskell: being lazy with class</em> <span class="citation" data-cites="hudak2007history">(Hudak et al. 2007)</span></p>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="ghc" class="slide level1">
<h1>GHC</h1>
<ul>
<li>Glasgow Haskell Compiler</li>
<li>Written in Haskell</li>
<li>Lead Developers:
<ul>
<li>Simon Peyton Jones (Microsoft Research)</li>
<li>Simon Marlow (Facebook)</li>
</ul></li>
<li>De facto default Haskell compiler</li>
<li><a href="https://gitlab.haskell.org/ghc/ghc/wikis/index">https://gitlab.haskell.org/ghc/ghc/wikis/index</a></li>
</ul>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="ghc-compilation-flow" class="slide level1">
<h1>GHC Compilation Flow</h1>
<div class="sourceCode" id="cb1" style="font-size: large"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                                                                          <span class="op">+---------+</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                                                         <span class="dt">LLVM</span> backend <span class="op">/--&gt;|</span> <span class="dt">LLVM</span> <span class="dt">IR</span> <span class="op">|-</span>\</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="op">|</span>   <span class="op">+---------+</span> <span class="op">|</span> <span class="dt">LLVM</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="op">|</span>               v</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a> <span class="op">+------------+</span> <span class="dt">Desugar</span>  <span class="op">+------+</span> <span class="dt">STGify</span>  <span class="op">+-----+</span> <span class="dt">CodeGen</span>  <span class="op">+-----+</span>    <span class="op">|</span>  <span class="dt">NCG</span>    <span class="op">+----------+</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> <span class="dt">Parse</span> tree <span class="op">|---------&gt;|</span> <span class="dt">Core</span> <span class="op">|--------&gt;|</span> <span class="dt">STG</span> <span class="op">|---------&gt;|</span> <span class="dt">C</span><span class="co">-- |----+--------&gt;| Assembly |</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a> <span class="op">+------------+</span>          <span class="op">+------+</span>         <span class="op">+-----+</span>          <span class="op">+-----+</span>    <span class="op">|</span>         <span class="op">+----------+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="op">|</span>            <span class="op">^</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="op">|</span>     <span class="op">+---+</span>  <span class="op">|</span> <span class="dt">GCC</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                                                            <span class="dt">C</span> backend \<span class="op">----&gt;|</span> <span class="dt">C</span> <span class="op">|--/</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="op">+---+</span></span></code></pre></div>
<p><a href="https://gitlab.haskell.org/ghc/ghc/wikis/commentary/compiler/generated-code" class="small">https://gitlab.haskell.org/ghc/ghc/wikis/commentary/compiler/generated-code</a></p>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="the-spineless-tagless-g-machine" class="slide level1">
<h1>The Spineless Tagless G-Machine</h1>
<p>Compiled graph reduction machine for a lazy functional language</p>
<dl>
<dt><span class="citation" data-cites="jones1992implementing">Jones (1992)</span>:</dt>
<dd><em>Implementing lazy functional languages on stock hardware: the Spineless Tagless G-machine</em>
</dd>
<dt><span class="citation" data-cites="marlow2004making">Marlow and Jones (2004)</span>:</dt>
<dd><em>Making a fast curry: push/enter vs. eval/apply for higher-order languages</em>
</dd>
<dt><span class="citation" data-cites="marlow2007faster">Marlow, Yakushev, and Peyton Jones (2007)</span>:</dt>
<dd><em>Faster Laziness Using Dynamic Pointer Tagging</em>
</dd>
</dl>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="other-examplespredecessors" class="slide level1">
<h1>Other examples/Predecessors</h1>
<ul>
<li>G-machine <span class="citation" data-cites="johnsson1984efficient">(Johnsson 1984)</span></li>
<li>TIM: Three Instruction Machine <span class="citation" data-cites="fairbairn1987tim">(Fairbairn and Wray 1987)</span></li>
</ul>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-4" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="spineless">Spineless</h2>
<ul>
<li>STG program is a graph, not a tree</li>
<li>Graph not represented as single data structure in memory</li>
<li>Small, individual parts of the graph that reference each other</li>
</ul>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-5" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="tagless">Tagless</h2>
<img class="decker" data-src="img/wellyes.jpg" alt="wellyes.jpg" style="width:75%;">
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-6" class="slide level1">
<h1></h1>
<dl>
<dt>Tagless</dt>
<dd>Refers to how a heap closure is evaluated
</dd>
<dd><code>f x y = case x of (a,b) -&gt; a+y</code>
</dd>
<dd>Before taking x apart: STGM pushes code to stack and jumps to entry code for x
</dd>
<dt>TagFUL</dt>
<dd>Closure to evaluate is only entered if its tag says it is unevaluated
</dd>
</dl>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="update-2007" class="slide level1">
<h1>Update 2007</h1>
<p><em>Faster Laziness Using Dynamic Pointer Tagging</em> <span class="citation" data-cites="marlow2007faster">(Marlow, Yakushev, and Peyton Jones 2007)</span></p>
<ul>
<li>Tagless scheme more expensive (additional indirect jumps)</li>
<li><em>Dynamic pointer tagging</em>: using spare low bits of a pointer to encode information about pointed-to closure</li>
</ul>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="heap-object-structure" class="slide level1">
<h1>Heap object structure</h1>
<img class="decker" data-src="img/table.png" alt="table.png">
<p>Here: every heap object has associated entry code. Therefore term “closure” is used for any heap object</p>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-7" class="slide level1">
<h1></h1>
<dl>
<dt>Closure</dt>
<dd>Block of static code together with values of its free variables. Physical representation of such a closure is a pointer to a contiguous block of heap-allocated storage
</dd>
<dt>Thunk</dt>
<dd>Suspended computation. In a non-strict language, values are passed in unevaluated form, and only evaluated when their value is actually required. These unevaluated forms capture a suspended computation and can be represented by a closure in the same way as a function value. When a thunk is forced for the first time, it is physically updated with its value
</dd>
</dl>
<p><span class="citation" data-cites="jones1992implementing">(Jones 1992)</span></p>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="saturated-calls" class="slide level1">
<h1>Saturated Calls</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>f x y <span class="ot">=</span> x<span class="op">*</span>y</span></code></pre></div>
<div class="box columns">
<h2 id="section-8"></h2>
<ul>
<li><code>(f 3 4)</code> is a call to a <strong>known function</strong> (saturated call)</li>
<li>Compiler simply loads arguments and calls code for <code>f</code> directly</li>
<li>What happens with “unknown” functions?</li>
</ul>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="example" class="slide level1">
<h1>Example</h1>
<div class="sourceCode" id="cb3" style="font-size: x-large"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">zipWith</span><span class="ot"> ::</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [b] <span class="ot">-&gt;</span> [c]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">zipWith</span> k [] [] <span class="ot">=</span> []</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">zipWith</span> k (x<span class="op">:</span>xs) (y<span class="op">:</span>ys) <span class="ot">=</span> k x y <span class="op">:</span> <span class="fu">zipWith</span> k xs ys</span></code></pre></div>
<div class="box columns">
<h2 id="section-9"></h2>
<ul>
<li>k is an <strong>unknown function</strong>
<ul>
<li>Might take one argument, compute for a while and return function that consumes next argument</li>
<li>Might take three arguments, so that result of <code>zipWith</code> is list of functions</li>
</ul></li>
</ul>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="pushenter-vs-evalapply" class="slide level1">
<h1>Push/Enter vs Eval/Apply</h1>
<div class="box columns">
<h2 id="section-10"></h2>
<dl>
<dt>Push/Enter</dt>
<dd>The function which statically knows its own arity examines the stack to figure out how many arguments it has been passed and where they are.
</dd>
</dl>
</div>
<div class="box columns">
<h2 id="section-11"></h2>
<dl>
<dt>Eval/Apply</dt>
<dd>The caller which statically knows what the arguments are examines the function closure, extracts its arity and makes an exact call to the function.
</dd>
</dl>
<p><span class="citation" data-cites="marlow2004making">(Marlow and Jones 2004)</span></p>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="the-stg-language-syntax" class="slide level1">
<h1>The STG Language (Syntax)</h1>
<div class="box columns">
<h2 id="expressions">Expressions</h2>
<div class="sourceCode" id="cb4" style="font-size: large"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>e <span class="op">::=</span> a</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> f a1 <span class="op">...</span> an                   (function call (n <span class="op">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="kw">let</span> x <span class="ot">=</span> obj <span class="kw">in</span> e    </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="kw">case</span> e <span class="kw">of</span> {alt1; <span class="op">...</span>; altn}   (n <span class="op">&gt;=</span> <span class="dv">1</span>)</span></code></pre></div>
</div>
<div class="box columns">
<h2 id="heap-objects">Heap objects</h2>
<div class="sourceCode" id="cb5" style="font-size: large"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>obj <span class="op">::=</span> <span class="dt">FUN</span>(x1 <span class="op">...</span> xn <span class="ot">-&gt;</span> e)   (<span class="dt">Function</span><span class="op">:</span> arity <span class="ot">=</span> n <span class="op">&gt;=</span><span class="dv">1</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">|</span> <span class="dt">PAP</span>(f a1 <span class="op">...</span> an)      (<span class="dt">Partial</span> application<span class="op">:</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                              f is always a <span class="dt">FUN</span> with arity(f) <span class="op">&gt;</span> n <span class="op">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">|</span> <span class="dt">CON</span>(<span class="dt">C</span> a1 <span class="op">...</span> an)      (<span class="dt">Saturated</span> constructor n <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">|</span> <span class="dt">THUNK</span> e</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">|</span> <span class="dt">BLACKHOLE</span>             (only during evaluation)</span></code></pre></div>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="example-map" class="slide level1">
<h1>Example: map</h1>
<div class="box columns">
<h2 id="haskell-1">Haskell</h2>
<div class="sourceCode" id="cb6" style="font-size: large"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span> f [] <span class="ot">=</span> []</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span> f (x<span class="op">:</span>xs) <span class="ot">=</span> f x <span class="op">:</span> <span class="fu">map</span> f xs</span></code></pre></div>
</div>
<div class="box columns">
<h2 id="stg">STG</h2>
<div class="sourceCode" id="cb7" style="font-size: large"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nil <span class="ot">=</span> <span class="dt">CON</span> <span class="dt">Nil</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span> <span class="ot">=</span> <span class="dt">FUN</span> (f xs <span class="ot">-&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> xs <span class="kw">of</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Nil</span> <span class="ot">-&gt;</span> nil</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Cons</span> y ys <span class="ot">-&gt;</span> <span class="kw">let</span> h <span class="ot">=</span> <span class="dt">THUNK</span> (f y)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                           t <span class="ot">=</span> <span class="dt">THUNK</span> (<span class="fu">map</span> f ys)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                           r <span class="ot">=</span> <span class="dt">CON</span> (<span class="dt">Cons</span> h t)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">in</span> r</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>     )</span></code></pre></div>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="ministg" class="slide level1">
<h1>Ministg</h1>
<ul>
<li><a href="https://github.com/bjpop/ministg">https://github.com/bjpop/ministg</a></li>
<li>STG interpreter written in Haskell</li>
<li>Provides insight in STG language evaluation</li>
<li>Optional tracing of program execution</li>
</ul>
<div class="box columns">
<h2 id="alternative-to-ministg">“Alternative” to ministg</h2>
<ul>
<li>stgi</li>
<li><a href="https://github.com/quchen/stgi">https://github.com/quchen/stgi</a></li>
<li>Also STG interpreter but based on <span class="citation" data-cites="jones1992implementing">(Jones 1992)</span></li>
</ul>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="example-1" class="slide level1">
<h1>Example</h1>
<div class="box columns">
<h2 id="program-apply.stg">Program: apply.stg</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">const</span> <span class="ot">=</span> <span class="dt">FUN</span>(x y <span class="ot">-&gt;</span> x);</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>apply <span class="ot">=</span> <span class="dt">FUN</span>(f x <span class="ot">-&gt;</span> f x);</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>twentytwo <span class="ot">=</span> <span class="dt">CON</span>(<span class="dt">I</span> <span class="dv">22</span>);</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="dt">THUNK</span>(apply <span class="fu">const</span> true twentytwo)</span></code></pre></div>
</div>
<div class="box columns">
<h2 id="output">Output</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>true</span></code></pre></div>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="evalapply-trace" class="slide level1">
<h1>Eval/Apply Trace</h1>
<dl>
<dt>Expression</dt>
<dd>Code that is under evaluation
</dd>
<dt>Stack</dt>
<dd>Stack of continuations. What to do when current expression is evaluated
</dd>
<dt>Heap</dt>
<dd>Finite mapping from variables to heap objects
</dd>
</dl>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-0">Step 0</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td></td>
<td><code>main</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>apply</code></td>
<td><code>FUN(f x -&gt; f_? x)</code></td>
</tr>
<tr class="odd">
<td><code>const</code></td>
<td><code>FUN(x y -&gt; x)</code></td>
</tr>
<tr class="even">
<td><code>main</code></td>
<td><code>THUNK(apply_2 const true twentytwo)</code></td>
</tr>
<tr class="odd">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
<tr class="even">
<td><code>twentytwo</code></td>
<td><code>CON(I 22)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-1" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-1-thunk-most-recent-rule-applied">Step 1: THUNK (most recent rule applied)</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td><code>upd * main</code></td>
<td><code>apply_2 const true twentytwo</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-1">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>apply</code></td>
<td><code>FUN(f x -&gt; f_? x)</code></td>
</tr>
<tr class="odd">
<td><code>const</code></td>
<td><div class="line-block"><code>FUN(x y -&gt; x)</code></div></td>
</tr>
<tr class="even">
<td><code>main</code></td>
<td><div class="line-block"><code>BLACKHOLE</code></div></td>
</tr>
<tr class="odd">
<td><code>true</code></td>
<td><div class="line-block"><code>CON(True)</code></div></td>
</tr>
<tr class="even">
<td><code>twentytwo</code></td>
<td><div class="line-block"><code>CON(I 22)</code></div></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-3" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-2-callk">Step 2: CALLK</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td><code>(* twentytwo)</code></td>
<td><code>const_? true</code></td>
</tr>
<tr class="odd">
<td><code>upd * main</code></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-2">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>const</code></td>
<td><code>FUN(x y -&gt; x)</code></td>
</tr>
<tr class="odd">
<td><code>main</code></td>
<td><code>BLACKHOLE</code></td>
</tr>
<tr class="even">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
<tr class="odd">
<td><code>twentytwo</code></td>
<td><code>CON(I 22)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-5" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-3-pap2">Step 3: PAP2</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td><code>(* twentytwo)</code></td>
<td><code>$0</code></td>
</tr>
<tr class="odd">
<td><code>upd * main</code></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-3">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>$0</code></td>
<td><code>PAP(const true)</code></td>
</tr>
<tr class="odd">
<td><code>const</code></td>
<td><code>FUN(x y -&gt; x)</code></td>
</tr>
<tr class="even">
<td><code>main</code></td>
<td><code>BLACKHOLE</code></td>
</tr>
<tr class="odd">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
<tr class="even">
<td><code>twentytwo</code></td>
<td><code>CON(I 22)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-7" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-4-retfun">Step 4: RETFUN</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td><code>upd * main</code></td>
<td><code>0_? twentytwo</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-4">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>$0</code></td>
<td><code>PAP(const true)</code></td>
</tr>
<tr class="odd">
<td><code>const</code></td>
<td><code>FUN(x y -&gt; x)</code></td>
</tr>
<tr class="even">
<td><code>main</code></td>
<td><code>BLACKHOLE</code></td>
</tr>
<tr class="odd">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
<tr class="even">
<td><code>twentytwo</code></td>
<td><code>CON(I 22)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-9" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-5-pcall">Step 5: PCALL</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td><code>upd * main</code></td>
<td><code>const_? true twentytwo</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-5">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>const</code></td>
<td><code>FUN(x y -&gt; x)</code></td>
</tr>
<tr class="odd">
<td><code>main</code></td>
<td><code>BLACKHOLE</code></td>
</tr>
<tr class="even">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
<tr class="odd">
<td><code>twentytwo</code></td>
<td><code>CON(I 22)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-11" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-6-exact">Step 6: EXACT</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td><code>upd * main</code></td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-6">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>main</code></td>
<td><code>BLACKHOLE</code></td>
</tr>
<tr class="odd">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-13" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="step-7-update">Step 7: UPDATE</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Stack</td>
<td>Expression</td>
</tr>
<tr class="even">
<td></td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="heap-7">Heap</h2>
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Variable</td>
<td>Object</td>
</tr>
<tr class="even">
<td><code>true</code></td>
<td><code>CON(True)</code></td>
</tr>
</tbody>
</table>
</div>
<div class="box columns">
<h2 id="section-14"></h2>
<p>The computation has completed</p>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="pushenter-trace" class="slide level1">
<h1>Push/Enter Trace</h1>
<p><a href="trace/trace_pe/step0.html" class="resource" target="_blank">html</a></p>
<p><a href="trace/trace_pe/step1.html" class="resource"></a> <a href="trace/trace_pe/step2.html" class="resource"></a> <a href="trace/trace_pe/step3.html" class="resource"></a> <a href="trace/trace_pe/step4.html" class="resource"></a> <a href="trace/trace_pe/step5.html" class="resource"></a> <a href="trace/trace_pe/step6.html" class="resource"></a> <a href="trace/trace_pe/step7.html" class="resource"></a></p>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="comparison" class="slide level1">
<h1>Comparison</h1>
<div class="box columns">
<h2 id="pro-evalapply">Pro Eval/Apply</h2>
<ul>
<li>When calling unknown function with right number of arguments, arguments can be passed in registers rather than on stack. For registerrich architecture strongest reason for e/a. p/e forces arguments to unknown functions to be passed on the stack</li>
<li>Easier to map to portable assembly language such as C or C - -</li>
<li>No need to distinguish return addresses from heap pointers. (“This is a big win” <span class="citation" data-cites="marlow2004making">(Marlow and Jones 2004)</span>)</li>
<li>No tagging for non-pointers</li>
</ul>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-14" class="slide level1">
<h1></h1>
<div class="box columns">
<h2 id="pro-pushenter">Pro Push/Enter</h2>
<ul>
<li>Appears to be natural fit with currying</li>
<li>Eliminates some PAP allocations compared to e/a</li>
<li>payload of PAP object can be self-describing because arguments are tagged. In contrast, an e/a PAP object relies on its FUN to describe the layout of he payload. this results in some extra complication in the garbage collector and an extra global invariant: a PAP must contain a FUN. cannot contain another PAP</li>
</ul>
</div>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="conclusion" class="slide level1">
<h1>Conclusion</h1>
<ul>
<li>It is impossible to a rational conclusion about performance based on just the differences between the models</li>
<li>Push/Enter seems to be natural fit with currying</li>
<li>Eval/Apply seems to have decisive advantages in terms of complexity</li>
<li>Easier to map code to portable assembly language with E/A</li>
<li>Bottom Line: If Eval/Apply is no more expensive than push/enter it is definitely to be preferred</li>
<li>Performance measuring shows: Eval/Apply is better</li>
</ul>
<p><span class="citation" data-cites="marlow2004making">(Marlow and Jones 2004)</span></p>
</section>
</div>
<div class="slide-wrapper">
<hr />
<section id="section-15" class="slide level1 unnumbered">
<h1 class="unnumbered"></h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-fairbairn1987tim" class="csl-entry" role="doc-biblioentry">
Fairbairn, Jon, and Stuart Wray. 1987. <span>“TIM: A Simple, Lazy Abstract Machine to Execute Supercombinators.”</span> In <em>Conference on Functional Programming Languages and Computer Architecture</em>, 34–45. Springer.
</div>
<div id="ref-hudak2007history" class="csl-entry" role="doc-biblioentry">
Hudak, Paul, John Hughes, Simon Peyton Jones, and Philip Wadler. 2007. <span>“A History of Haskell: Being Lazy with Class.”</span> In <em>Proceedings of the Third ACM SIGPLAN Conference on History of Programming Languages</em>, 12–11. ACM.
</div>
<div id="ref-johnsson1984efficient" class="csl-entry" role="doc-biblioentry">
Johnsson, Thomas. 1984. <em>Efficient Compilation of Lazy Evaluation</em>. Vol. 19. 6. ACM.
</div>
<div id="ref-jones1992implementing" class="csl-entry" role="doc-biblioentry">
Jones, Simon L Peyton. 1992. <span>“Implementing Lazy Functional Languages on Stock Hardware: The Spineless Tagless g-Machine.”</span> <em>Journal of Functional Programming</em> 2 (2). Cambridge University Press: 127–202.
</div>
<div id="ref-marlow2004making" class="csl-entry" role="doc-biblioentry">
Marlow, Simon, and Simon Peyton Jones. 2004. <span>“Making a Fast Curry: Push/Enter Vs. Eval/Apply for Higher-Order Languages.”</span> In <em>ACM SIGPLAN Notices</em>, 39:4–15. 9. ACM.
</div>
<div id="ref-marlow2007faster" class="csl-entry" role="doc-biblioentry">
Marlow, Simon, Alexey Rodriguez Yakushev, and Simon Peyton Jones. 2007. <span>“Faster Laziness Using Dynamic Pointer Tagging.”</span> In <em>Acm Sigplan Notices</em>, 42:277–88. 9. ACM.
</div>
</div>
</section>
</div>
</section>
<!-- The previous line must be left aligned! -->

        <script src="support/vendor/js/jquery.min.js" type="text/javascript"></script>
        <script src="support/vendor/js/lazyload.min.js" type="text/javascript"></script>
        <script src="support/js/handout.js"></script>

        <script type="module">
          import {prepareExaminer} from "./support/examiner/examiner.js";
          prepareExaminer();
        </script>

                        <hr>
        <address>
                    <p class="date">2019-07-20</p>
                    <p class="author"> Armin Bernstetter</p>
                  </address>
        <script>
          var lazyLoadInstance = new LazyLoad({
            elements_selector: "img, video, iframe"
          });
        </script>
            </body>
  </html>
